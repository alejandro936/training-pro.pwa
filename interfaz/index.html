<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport"
      content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>TRAINING PRO</title>

<link href="https://fonts.googleapis.com/css2?family=Sora:wght@600;700;800&family=Space+Grotesk:wght@600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0b0b0b; --panel:#121212; --line:#272727; --fg:#f7f7f7; --accent:#E6C06E; --chip:#e0e0e0;
    --title-font:"Sora","Space Grotesk",Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
    --content-max: 860px;
    --side-pad: 28px;
    --gap-top: 30px;
    --gap-cards: 22px;
    --card-pad-x: 14px; --card-pad-y: 14px; --radius: 12px;
  }

  *{ box-sizing:border-box }
  html,body{
    margin:0; color:var(--fg); background:var(--bg);
    font:16px/1.55 "Inter",system-ui,Segoe UI,Roboto,Helvetica,Arial;
    height:100%; min-height:-webkit-fill-available; overflow-x:hidden;
    -webkit-touch-callout:none; -webkit-text-size-adjust:100%; touch-action:manipulation;
  }

  .wrap{
    max-width:1200px; margin:0 auto;
    padding:max(24px, env(safe-area-inset-top))
            max(var(--side-pad), env(safe-area-inset-right))
            max(44px, env(safe-area-inset-bottom))
            max(var(--side-pad), env(safe-area-inset-left));
    min-height:100vh;
  }
  @supports (min-height:100dvh){ .wrap{ min-height:100dvh; } }

  .top-spacer{ height:54px; }

  header{ margin:0 0 var(--gap-top); }
  h1{
    margin:0 auto;
    max-width:var(--content-max);
    font-family:var(--title-font);
    font-weight:800; letter-spacing:-0.01em; line-height:1.02;
    font-size:clamp(36px, 8vw, 52px);
  }

  .back-fab{
    position: fixed; z-index: 10050;
    top: calc(env(safe-area-inset-top) + 2px);
    left: calc(env(safe-area-inset-left) + 4px);
    padding: 7px 11px; font-size: 12px; line-height: 1; color:#fff;
    background: linear-gradient(180deg, rgba(230,192,110,.22), rgba(230,192,110,.06));
    border:1px solid var(--accent); border-radius: 9px; box-shadow: 0 6px 14px rgba(0,0,0,.25);
    cursor:pointer; -webkit-tap-highlight-color: transparent; touch-action: manipulation;
  }
  .logout-fab{
    position: fixed; z-index: 10050;
    top: calc(env(safe-area-inset-top) + 2px);
    right: calc(env(safe-area-inset-right) + 4px);
    padding: 7px 11px; font-size: 12px; line-height: 1; color:#fff;
    background: linear-gradient(180deg, rgba(230,192,110,.22), rgba(230,192,110,.06));
    border:1px solid var(--accent); border-radius: 9px; box-shadow: 0 6px 14px rgba(0,0,0,.25);
    cursor:pointer; -webkit-tap-highlight-color: transparent; touch-action: manipulation;
  }
  .back-fab:hover{ border-color:rgba(230,192,110,.65); }
  .back-fab:active{ transform: translateY(1px); }

  .toolbar{
    display:flex; gap:10px; margin:0 auto calc(var(--gap-top) + 10px);
    max-width:var(--content-max); width:100%; flex-wrap:wrap;
  }
  .toolbar input{
    flex:1 1 320px; min-width:0; background:#121212; color:var(--fg);
    border:1px solid #1d1d1d; border-radius:10px; padding:13px 16px; font-size:16px;
    transition:box-shadow .18s ease,border-color .18s ease;
  }
  .toolbar input:focus{ outline:none; border-color:#2a2a2a; box-shadow:0 0 0 2px rgba(255,255,255,.12); }
  .toolbar button{
    flex:0 0 auto; background:#121212; color:#fff; border:1px solid var(--line);
    border-radius:9px; padding:6px 9px; font-size:13px; line-height:1;
  }
  .toolbar .primary{
    background:linear-gradient(180deg,rgba(230,192,110,.16),rgba(230,192,110,.05));
    border-color:var(--accent)
  }
  .chip-filter{
    flex:0 0 auto; display:none; align-items:center; gap:6px;
    padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.22);
    color:#ddd; font-size:13px;
  }
  .chip-filter button{
    background:#181818; border:1px solid rgba(230,192,110,.45); border-radius:8px; padding:2px 6px; font-size:11px;
  }

  .grid{ display:grid; grid-template-columns:1fr; gap:var(--gap-cards) 0;
    align-items:stretch; max-width:var(--content-max); width:100%; margin:0 auto; }
  .card{
    background:var(--panel); border:1px solid rgba(255,255,255,.14);
    border-left:3px solid rgba(230,192,110,.85); border-radius:var(--radius);
    padding:var(--card-pad-y) var(--card-pad-x); display:flex; flex-direction:column; gap:8px;
    box-shadow:0 1px 8px rgba(0,0,0,.22); position:relative;
  }
  .card-body{ max-width:78%; display:flex; flex-direction:column; gap:6px; }
  .title{ font-family:var(--title-font); font-weight:800; font-size:clamp(18px, 4.2vw, 22px); line-height:1.2; letter-spacing:.2px; margin:0 0 2px; }
  .chip{ margin:4px 0 6px; display:inline-flex; align-items:center; justify-content:center;
    padding:5px 9px; border-radius:999px; border:1px solid rgba(255,255,255,.18); color:var(--chip); font-size:12px; width:fit-content; }
  .desc{ color:#d0d0d0; text-align:left; font-size:14.5px; font-style:italic; line-height:1.55;
    margin-top:2px; min-height:calc(1.55em * 3); max-height:calc(1.55em * 3 + 8px);
    overflow:hidden; position:relative; }
  .desc .line{ margin:.35em 0; }
  .desc:after{ content:""; position:absolute; left:0; right:0; bottom:0; height:2.4em;
    background:linear-gradient(180deg, rgba(18,18,18,0), var(--panel)); pointer-events:none; }
  .desc .line:nth-child(n+4){ display:none; }

  .actions{ display:flex; gap:8px; justify-content:flex-start; margin-top:6px; }
  .btn{ background:#121212; border:1.5px solid rgba(230,192,110,.38); padding:8px 10px; border-radius:9px; color:#e9e9e9; font-size:14.5px; }

  .footer{ display:flex; justify-content:center; margin:22px 0 8px }
  .more{ padding:8px 10px; border-radius:9px; border:1px solid var(--accent); background:transparent; color:#fff; font-size:15px }

  .error{ max-width:900px; margin:0 auto 12px; background:#1a0000; border:1px solid #4a0000; color:#ffb3b3;
    padding:10px 12px; border-radius:10px; display:none }

  /* MÚSCULOS: tarjetas tipo “carpeta” */
  .folder{
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    background:var(--panel); border:1px solid rgba(255,255,255,.14);
    border-left:3px solid rgba(230,192,110,.85); border-radius:var(--radius);
    padding:14px; cursor:pointer;
  }
  .folder .name{ font-family:var(--title-font); font-weight:800; font-size:18px; }
  .folder .count{ font-size:12px; color:#cfcfcf; border:1px solid rgba(255,255,255,.2); border-radius:999px; padding:4px 8px; }
</style>

<!-- Guard de sesión (redirige a /door si no hay token) -->
<style>html.guard-hiding{visibility:hidden}</style>
<script>
  (function(){
    document.documentElement.classList.add('guard-hiding');
    try {
      var m = document.cookie.match(/(?:^|;\s*)tp_token_v1=([^;]+)/);
      var tk = (m && m[1]) || '';
      if (!tk) tk = localStorage.getItem('tp_token_v1') || '';
      if (tk && tk.length > 10) {
        document.documentElement.classList.remove('guard-hiding');
        return;
      }
    } catch (_) {}
    var back = location.pathname + location.search;
    var qs = '?redirect=' + encodeURIComponent(back) + '&force=1';
    location.replace('/door.html' + qs);
  })();
</script>
</head>
<body>

<button class="back-fab"   onclick="goHome(event)" aria-label="Volver a inicio">← Volver</button>
<button class="logout-fab" onclick="logout()"      aria-label="Cerrar sesión">Cerrar sesión</button>

<div class="wrap">
  <div class="top-spacer" aria-hidden="true"></div>
  <header><h1>TRAINING PRO</h1></header>

  <div class="toolbar">
    <input id="q" placeholder="Buscar ejercicio, categoría o indicación…">
    <button class="primary" onclick="buscar()">Buscar</button>
    <button onclick="limpiar()">Limpiar</button>

    <!-- chip del filtro por músculo (visible solo en vista lista con filtro) -->
    <div id="chipFilter" class="chip-filter">
      <span id="chipLabel"></span>
      <button onclick="clearMuscle()">Quitar</button>
    </div>
  </div>

  <div id="err" class="error"></div>
  <div id="grid" class="grid"></div>

  <div class="footer">
    <button id="more" class="more" style="display:none" onclick="cargarMasUI()">Cargar más</button>
  </div>
</div>

<div id="modal" class="modal" onclick="if(event.target.id==='modal')closeModal()">
  <div class="panel">
    <div class="topbar"><button class="x" onclick="closeModal()">Cerrar ✕</button></div>
    <div id="detail"></div>
  </div>
</div>

<script>
/* ======== Utilidades ======== */
var CHUNK = 9;
['gesturestart','gesturechange','gestureend'].forEach(function(evt){
  document.addEventListener(evt, function(e){ e.preventDefault(); }, { passive:false });
});

// === Estado global ===
var state = {
  q: '',
  items: [],       // todos los ejercicios cargados
  rendered: 0,     // cuántas tarjetas de ejercicios están pintadas
  nextOffset: '',
  loading: false,
  view: 'muscles', // 'muscles' | 'list'
  muscle: ''       // nombre del músculo filtrado en vista list
};

function goHome(e){
  e.preventDefault();
  try{
    var ref = document.referrer ? new URL(document.referrer) : null;
    if (ref && ref.origin === location.origin && history.length > 1) { history.back(); return; }
  }catch(_){}
  location.href = '/';
}
function deleteCookie(name){
  try{
    document.cookie = name + '=; Path=/; Max-Age=0; Expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite:Lax; Secure';
  }catch(_){}
}
async function kick(){
  try{
    localStorage.removeItem('tp_token_v1');
    localStorage.removeItem('tp_sessionId');
    localStorage.removeItem('tp_redirect');
    localStorage.removeItem('tp_email');
    deleteCookie('tp_token_v1'); deleteCookie('tp_redirect'); deleteCookie('tp_email');
    if ('caches' in self){ try { await caches.delete('tp-session'); } catch(_){ } }
  }finally{ window.location.assign('/'); }
}

async function logout(){
  try {
    const email = localStorage.getItem('tp_email');
    if (email) {
      const res = await fetch('/api/auth/logout', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      });
      const result = await res.json();
      if (!result.ok) console.error('Error desde backend:', result.error);
    }
    localStorage.removeItem('tp_token_v1');
    localStorage.removeItem('tp_redirect');
    localStorage.removeItem('tp_email');
    localStorage.removeItem('deviceId');
    deleteCookie('tp_token_v1'); deleteCookie('tp_redirect'); deleteCookie('tp_email');
    if ('caches' in self){ try { await caches.delete('tp-session'); } catch(_){} }
    location.replace('/door.html?force=1');
  } catch (err) { console.error('Error al cerrar sesión:', err); }
}

function showErr(msg){
  var box = document.getElementById('err');
  if(!msg){ box.style.display='none'; box.textContent=''; return; }
  box.textContent = msg; box.style.display='block';
}
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }

/* ======== Normalizadores y orden ======== */
function normStr(s){ return String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,''); }
function compareByName(a,b){
  const A = normStr(a.ejercicio || a.nombre || '');
  const B = normStr(b.ejercicio || b.nombre || '');
  if (A < B) return -1; if (A > B) return 1; return 0;
}
function sortItems(){ try { state.items.sort(compareByName); } catch(_){} }
function mergeUnique(existing, incoming){
  const seen = new Map(existing.map(x => [x.id, true]));
  for (const x of incoming) if (!seen.has(x.id)) { existing.push(x); seen.set(x.id,true); }
}

/* ======== MÚSCULOS: indexado y render ======== */
function getMuscleName(x){
  return (x.musculo || x['músculo'] || x.musculo_objetivo || x.musculoObjetivo || '').trim();
}
function buildMuscleIndex(){
  const map = new Map();
  for (const it of state.items){
    const name = getMuscleName(it) || 'Sin músculo';
    const key  = normStr(name);
    const cur = map.get(key) || { name, key, count:0 };
    cur.count += 1;
    // preserva capitalización “bonita”
    if (name.length > cur.name.length) cur.name = name;
    map.set(key, cur);
  }
  // orden A→Z por nombre visible
  return Array.from(map.values()).sort((a,b)=> (a.name.localeCompare(b.name, 'es', {sensitivity:'base'})));
}
function renderMuscles(){
  const grid = document.getElementById('grid');
  const groups = buildMuscleIndex();
  grid.innerHTML = groups.map(g => (
    '<div class="folder" onclick="selectMuscle(\''+escapeHtml(g.name).replace(/'/g,"&#39;")+'\')">'+
      '<div class="name">'+escapeHtml(g.name)+'</div>'+
      '<div class="count">'+g.count+'</div>'+
    '</div>'
  )).join('');
  // footer: mostrar “Cargar más” si hay más páginas
  document.getElementById('more').style.display = state.nextOffset ? 'inline-block' : 'none';
  // chip oculto en vista músculos
  document.getElementById('chipFilter').style.display = 'none';
}

/* ======== Vista lista: render ejercicios con filtro de músculo ======== */
function card(x){
  var nombre = escapeHtml(x.ejercicio || x.nombre || '');
  var cat = x.categoria ? '<span class="chip">'+escapeHtml(x.categoria)+'</span>' : '';
  var indHtml = formatIndicaciones3(x.indicaciones || x.descripcion || '');
  var musc = getMuscleName(x);
  var muscHtml = musc ? ('<div class="section"><div>'+escapeHtml(musc)+'</div></div>') : '';
  var btnVid = x.video ? '<a class="btn link" href="'+x.video+'" target="_blank" rel="noopener">Abrir vídeo ↗</a>' : '<span class="btn" style="opacity:.6">Sin vídeo</span>';
  return '<div class="card"><div class="card-body"><div class="title">'+nombre+'</div>'+(cat?'<div>'+cat+'</div>':'')+'<div class="section"><div class="desc">'+indHtml+'</div></div>'+muscHtml+'</div><div class="actions">'+btnVid+'<button class="btn" onclick="detalle(\''+x.id+'\')">Detalle</button></div></div>';
}
function resetGrid(){ document.getElementById('grid').innerHTML = ''; state.rendered = 0; }
function setMoreVisibility(){
  var more = (state.rendered < filteredItems().length) || !!state.nextOffset;
  document.getElementById('more').style.display = more ? 'inline-block' : 'none';
}
function filteredItems(){
  // aplica filtro por músculo en vista lista
  if (state.view !== 'list') return state.items;
  if (!state.muscle) return state.items;
  const key = normStr(state.muscle);
  return state.items.filter(x => normStr(getMuscleName(x)) === key);
}
function renderRange(from, to){
  const arr = filteredItems();
  if (from >= to) return;
  const slice = arr.slice(from, to);
  if (!slice.length) return;
  const html = slice.map(card).join('');
  document.getElementById('grid').insertAdjacentHTML('beforeend', html);
  state.rendered = to;
  setMoreVisibility();
}
function renderInitial(){ renderRange(0, Math.min(CHUNK, filteredItems().length)); }
function renderMore(){ renderRange(state.rendered, Math.min(state.rendered + CHUNK, filteredItems().length)); }

/* ======== API ======== */
function getToken(){ try { return localStorage.getItem('tp_token_v1') || ''; } catch { return ''; } }
async function apiList(opts){
  const qs = new URLSearchParams({ q: opts.q || '', offset: opts.offset || '' });
  const r  = await fetch('/api/ejercicios?' + qs.toString(), {
    headers: { 'Authorization': 'Bearer ' + getToken() },
    credentials:'include'
  });
  if (r.status === 401) { kick(); throw new Error('HTTP 401'); }
  if (!r.ok) throw new Error('HTTP '+r.status);
  return r.json();
}
async function apiDetail(id){
  const r = await fetch('/api/ejercicios?id=' + encodeURIComponent(id), {
    headers: { 'Authorization': 'Bearer ' + getToken() },
    credentials:'include'
  });
  if (r.status === 401) { kick(); throw new Error('HTTP 401'); }
  if (!r.ok) throw new Error('HTTP '+r.status);
  return r.json();
}

/* ======== Carga y render segun vista ======== */
async function fetchData(opts){
  opts = opts || {};
  if (state.loading) return;
  state.loading = true; showErr('');

  const prevRendered = state.rendered;
  const prevScrollY = window.scrollY;

  try{
    const res = await apiList({
      q: (typeof opts.q!=='undefined' ? opts.q : state.q),
      offset: (opts.offset || '')
    });
    const rows = (res && Array.isArray(res.rows)) ? res.rows : [];

    if (!opts.append){
      state.items = rows.slice();
      state.nextOffset = res.nextOffset || '';
    } else {
      mergeUnique(state.items, rows);
      state.nextOffset = res.nextOffset || '';
    }

    sortItems(); // A→Z por ejercicio

    // Render por vista
    resetGrid();
    if (state.view === 'muscles') {
      renderMuscles();
    } else {
      const target = Math.max(CHUNK, prevRendered);
      renderRange(0, Math.min(target, filteredItems().length));
      try { window.scrollTo(0, prevScrollY); } catch(_){}
    }

  }catch(err){
    if (String(err).includes('401')) return;
    showErr('Error cargando datos: ' + String(err.message || err));
  }finally{
    state.loading = false;
  }
}

/* ======== UX: acciones ======== */
function selectMuscle(name){
  state.view = 'list';
  state.muscle = name || '';
  document.getElementById('chipLabel').textContent = 'Músculo: ' + (state.muscle || '—');
  document.getElementById('chipFilter').style.display = state.muscle ? 'inline-flex' : 'none';
  // pintar lista filtrada (sin tocar q)
  resetGrid();
  renderInitial();
  setMoreVisibility();
}
function clearMuscle(){
  state.muscle = '';
  document.getElementById('chipFilter').style.display = 'none';
  // si no hay búsqueda activa, volvemos a vista músculos
  if (!state.q) {
    state.view = 'muscles';
    resetGrid();
    renderMuscles();
    return;
  }
  // si hay q, mantenemos lista pero sin filtro de músculo
  resetGrid();
  renderInitial();
  setMoreVisibility();
}
function cargarMasUI(){
  if (state.view === 'muscles') {
    if (state.nextOffset && !state.loading) fetchData({ q: state.q, offset: state.nextOffset, append: true });
  } else {
    const arr = filteredItems();
    if (state.rendered < arr.length) renderMore();
    else if (state.nextOffset && !state.loading) fetchData({ q: state.q, offset: state.nextOffset, append: true });
  }
}
function buscar(){
  state.q = document.getElementById('q').value.trim();
  state.view = state.q ? 'list' : 'muscles'; // con texto → lista; vacío → músculos
  // Cuando hay búsqueda, ignoramos filtro de músculo (o lo mantenemos si quieres)
  fetchData({ q: state.q });
}
function limpiar(){
  document.getElementById('q').value='';
  state.q=''; state.view='muscles'; state.muscle='';
  document.getElementById('chipFilter').style.display = 'none';
  fetchData({ q:'' });
}

/* ======== Detalle ======== */
async function detalle(id){
  try{
    const r = await apiDetail(id);
    const d = r && r.detail;
    var nombre = (d && (d.nombre || d.ejercicio)) || 'Ejercicio';
    var cat = (d && d.categoria) ? d.categoria : '';
    var ind = (d && (d.descripcion || d.indicaciones)) || '';
    var vid = (d && d.video) || '';
    var html =
      '<div class="detail-title">'+escapeHtml(nombre)+'</div>'+
      (cat ? '<div class="detail-chip">'+escapeHtml(cat)+'</div>' : '')+
      (vid ? embedVideo(vid) : '')+
      '<div class="detail-body">'+formatIndicaciones(ind)+'</div>';
    document.getElementById('detail').innerHTML = html;
    document.getElementById('modal').style.display = 'flex';
  }catch(err){
    if (String(err).includes('401')) return;
    showErr('Error detalle: ' + String(err.message || err));
  }
}
function closeModal(){ document.getElementById('modal').style.display = 'none'; }

document.addEventListener('DOMContentLoaded', function(){ fetchData(); });
window.addEventListener('pageshow', function(e){ if (e.persisted) fetchData(); });
</script>

<!-- Guard “online”: invalida si borras SESSIONS -->
<script>
(async function guard(){
  const token = localStorage.getItem('tp_token_v1') || '';
  if (!token) { kick(); return; }
  const ok = await check(token);
  if (!ok) { kick(); return; }
  setInterval(async ()=>{
    const tok = localStorage.getItem('tp_token_v1') || '';
    if (!tok || !(await check(tok))) kick();
  }, 5 * 60 * 1000);
  document.addEventListener('visibilitychange', async () => {
    if (document.visibilityState === 'visible') {
      const tok = localStorage.getItem('tp_token_v1') || '';
      if (!tok || !(await check(tok))) kick();
    }
  });
})();
async function check(token){
  try{
    const r = await fetch('/api/auth/check', {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'Authorization': 'Bearer ' + token },
      body: JSON.stringify({ token })
    });
    return r.ok;
  }catch{ return false; }
}
function kick(){
  try{
    localStorage.removeItem('tp_token_v1');
    localStorage.removeItem('tp_sessionId');
  }catch{}
  window.location.assign('/'); // portada
}
</script>
</body>
</html>

