<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>TRAINING PRO</title>

<link href="https://fonts.googleapis.com/css2?family=Sora:wght@600;700;800&family=Space+Grotesk:wght@600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0b0b0b; --panel:#121212; --line:#272727; --fg:#f7f7f7; --accent:#E6C06E; --chip:#e0e0e0;
    --title-font:"Sora","Space Grotesk",Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
    --content-max: 860px;
    --side-pad: 28px;
    --gap-top: 30px;
    --gap-cards: 22px;
    --card-pad-x: 14px; --card-pad-y: 14px; --radius: 12px;

    --nav-h: 56px;
    --nav-gap: 12px;
  }

  *{ box-sizing:border-box }
  html,body{
    margin:0; color:var(--fg); background:var(--bg);
    font:16px/1.55 "Inter",system-ui,Segoe UI,Roboto,Helvetica,Arial;
    height:100%; min-height:-webkit-fill-available; overflow-x:hidden;
    -webkit-touch-callout:none; -webkit-text-size-adjust:100%; touch-action:manipulation;
  }

  .wrap{
    max-width:1200px; margin:0 auto;
    padding:max(24px, env(safe-area-inset-top))
            max(var(--side-pad), env(safe-area-inset-right))
            calc(var(--nav-h) + var(--nav-gap) + 28px + env(safe-area-inset-bottom))
            max(var(--side-pad), env(safe-area-inset-left));
    min-height:100vh;
  }
  @supports (min-height:100dvh){ .wrap{ min-height:100dvh; } }

  .top-spacer{ height:54px; }

  header{ margin:0 0 var(--gap-top); }
  h1{
    margin:0 auto;
    max-width:var(--content-max);
    font-family:var(--title-font);
    font-weight:800; letter-spacing:-0.01em; line-height:1.02;
    font-size:clamp(36px, 8vw, 52px);
  }

  .logout-fab{
    position: fixed; z-index: 10050;
    top: calc(env(safe-area-inset-top) + 2px);
    right: calc(env(safe-area-inset-right) + 4px);
    padding: 7px 11px; font-size: 12px; line-height: 1; color:#fff;
    background: linear-gradient(180deg, rgba(230,192,110,.22), rgba(230,192,110,.06));
    border:1px solid var(--accent); border-radius: 9px; box-shadow: 0 6px 14px rgba(0,0,0,.25);
    cursor:pointer; -webkit-tap-highlight-color: transparent; touch-action: manipulation;
  }
  .logout-fab:hover{ border-color:rgba(230,192,110,.65); }

  .toolbar{
    display:flex; gap:10px; margin:0 auto calc(var(--gap-top) + 10px);
    max-width:var(--content-max); width:100%; flex-wrap:wrap;
  }
  .toolbar input{
    flex:1 1 320px; min-width:0; background:#121212; color:var(--fg);
    border:1px solid #1d1d1d; border-radius:10px; padding:13px 16px; font-size:16px;
    transition:box-shadow .18s ease,border-color .18s ease;
  }
  .toolbar input:focus{ outline:none; border-color:#2a2a2a; box-shadow:0 0 0 2px rgba(255,255,255,.12); }
  .toolbar button{
    flex:0 0 auto; background:#121212; color:#fff; border:1px solid var(--line);
    border-radius:9px; padding:6px 9px; font-size:13px; line-height:1;
  }
  .toolbar .primary{
    background:linear-gradient(180deg,rgba(230,192,110,.16),rgba(230,192,110,.05));
    border-color:var(--accent)
  }
  .chip-filter{
    flex:0 0 auto; display:none; align-items:center; gap:6px;
    padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.22);
    color:#ddd; font-size:13px;
  }
  .chip-filter button{
    background:#181818; border:1px solid rgba(230,192,110,.45); border-radius:8px; padding:2px 6px; font-size:11px;
  }

  .grid{ display:grid; grid-template-columns:1fr; gap:var(--gap-cards) 0;
    align-items:stretch; max-width:var(--content-max); width:100%; margin:0 auto; }
  .card{
    background:var(--panel); border:1px solid rgba(255,255,255,.14);
    border-left:3px solid rgba(230,192,110,.85); border-radius:var(--radius);
    padding:var(--card-pad-y) var(--card-pad-x); display:flex; flex-direction:column; gap:8px;
    box-shadow:0 1px 8px rgba(0,0,0,.22); position:relative;
  }
  .card-body{ max-width:78%; display:flex; flex-direction:column; gap:6px; }
  .title{ font-family:var(--title-font); font-weight:800; font-size:clamp(18px, 4.2vw, 22px); line-height:1.2; letter-spacing:.2px; margin:0 0 2px; }
  .chip{ margin:4px 0 6px; display:inline-flex; align-items:center; justify-content:center;
    padding:5px 9px; border-radius:999px; border:1px solid rgba(255,255,255,.18); color:var(--chip); font-size:12px; width:fit-content; }
  .desc{ color:#d0d0d0; text-align:left; font-size:14.5px; font-style:italic; line-height:1.55;
    margin-top:2px; min-height:calc(1.55em * 3); max-height:calc(1.55em * 3 + 8px);
    overflow:hidden; position:relative; }
  .desc .line{ margin:.35em 0; }
  .desc:after{ content:""; position:absolute; left:0; right:0; bottom:0; height:2.4em;
    background:linear-gradient(180deg, rgba(18,18,18,0), var(--panel)); pointer-events:none; }
  .desc .line:nth-child(n+4){ display:none; }

  .actions{ display:flex; gap:8px; justify-content:flex-start; margin-top:6px; }
  .btn{
    background:#121212; border:1.5px solid rgba(230,192,110,.38);
    padding:9px 12px; border-radius:10px; color:#e9e9e9; font-size:14.5px;
    text-decoration:none; display:inline-block;
  }
  .btn.primary{
    background: linear-gradient(180deg, rgba(230,192,110,.22), rgba(230,192,110,.06));
    border-color: var(--accent);
    color:#fff;
    box-shadow: 0 6px 14px rgba(0,0,0,.25);
  }
  .btn.ghost{
    background:#121212;
    border-color: rgba(255,255,255,.18);
    color:#e9e9e9;
  }

  .footer{ display:flex; justify-content:center; margin:22px 0 8px }
  .more{ padding:8px 10px; border-radius:9px; border:1px solid var(--accent); background:transparent; color:#fff; font-size:15px }

  .error{ max-width:900px; margin:0 auto 12px; background:#1a0000; border:1px solid #4a0000; color:#ffb3b3;
    padding:10px 12px; border-radius:10px; display:none }

  .folder{
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    background:var(--panel); border:1px solid rgba(255,255,255,.14);
    border-left:3px solid rgba(230,192,110,.85); border-radius:var(--radius);
    padding:14px; cursor:pointer;
  }
  .folder .name{ font-family:var(--title-font); font-weight:800; font-size:18px; }
  .folder .count{ font-size:12px; color:#cfcfcf; border:1px solid rgba(255,255,255,.2); border-radius:999px; padding:4px 8px; }

  .modal{
    position:fixed; inset:0; display:none;
    align-items:center; justify-content:center; padding:18px;
    background:rgba(0,0,0,.7);
    z-index:20000;
  }
  .panel{
    position:relative; background:var(--panel);
    border:1px solid rgba(230,192,110,.35);
    border-radius:14px; max-width:860px; width:100%;
    padding:12px 14px 14px; box-shadow:0 10px 40px rgba(0,0,0,.5);
    text-align:center;
  }
  .panel .topbar{ display:flex; justify-content:flex-end; align-items:center; margin-bottom:4px; }
  .panel .x{
    border:1px solid rgba(230,192,110,.45); background:#181818; color:#fff;
    border-radius:8px; padding:3px 7px; cursor:pointer; font-size:11px;
  }
  .detail-title{
    margin:4px 0 10px; font-weight:900;
    font-size:clamp(21px,4.6vw,28px);
    letter-spacing:.02em;
  }
  .detail-chip{
    display:inline-block; margin:0 auto 10px; padding:6px 10px;
    border-radius:999px; border:1px solid rgba(255,255,255,.22); color:#ddd; font-size:12px;
  }
  .detail-body{
    font-style: italic;
    line-height: 1.75;
    font-size: 15px;
  }
  .detail-body .line{ margin: .45em 0; }
  .detail-body .line.num{ margin-top: .85em; }

  .nav-bottom{
    position: fixed; z-index: 15000;
    left:0; right:0; bottom:0;
    padding: 8px 12px calc(env(safe-area-inset-bottom) + var(--nav-gap));
    background: var(--panel);
    border-top: 1px solid rgba(255,255,255,.8);
    box-shadow: 0 -6px 18px rgba(0,0,0,.35);
    border-radius: 0;
    display:flex; align-items:center; justify-content:center; gap:10px;
  }
  .nav-btn{
    min-width: 104px;
    height: 36px;
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    padding:0 12px; border-radius:10px; font-size:13px; line-height:1;
    cursor:pointer; -webkit-tap-highlight-color:transparent;
    user-select:none;
  }
  .nav-btn.primary{
    background: linear-gradient(180deg, rgba(230,192,110,.22), rgba(230,192,110,.06));
    border:1px solid var(--accent); color:#fff; box-shadow:0 4px 10px rgba(0,0,0,.25);
  }
  .nav-btn.secondary{
    background:#191919; border:1px solid rgba(255,255,255,.18); color:#e9e9e9;
  }
  .nav-btn[disabled]{ opacity:.5; cursor:not-allowed; filter:saturate(.6); }
</style>

<style>html.guard-hiding{visibility:hidden}</style>
<script>
  (function(){
    document.documentElement.classList.add('guard-hiding');
    try {
      var m = document.cookie.match(/(?:^|;\s*)tp_token_v1=([^;]+)/);
      var tk = (m && m[1]) || '';
      if (!tk) tk = localStorage.getItem('tp_token_v1') || '';
      if (tk && tk.length > 10) {
        document.documentElement.classList.remove('guard-hiding');
        return;
      }
    } catch (_) {}
    var back = location.pathname + location.search;
    var qs = '?redirect=' + encodeURIComponent(back) + '&force=1';
    location.replace('/door.html' + qs);
  })();
</script>
</head>
<body>

<button class="logout-fab" onclick="logout()" aria-label="Cerrar sesión">Cerrar sesión</button>

<div class="wrap">
  <div class="top-spacer" aria-hidden="true"></div>
  <header><h1>TRAINING PRO</h1></header>

  <div class="toolbar">
    <input id="q" placeholder="Buscar ejercicio, categoría o indicación…"
           autocomplete="off" autocapitalize="none" spellcheck="false">
    <button class="primary" onclick="buscar()">Buscar</button>
    <button onclick="limpiar()">Limpiar</button>

    <div id="chipFilter" class="chip-filter">
      <span id="chipLabel"></span>
      <button onclick="clearCategory()">Quitar</button>
    </div>
  </div>

  <div id="err" class="error"></div>
  <div id="grid" class="grid"></div>

  <div class="footer">
    <button id="more" class="more" style="display:none" onclick="cargarMasUI()">Cargar más</button>
  </div>
</div>

<div id="modal" class="modal" onclick="if(event.target.id==='modal')closeModal()">
  <div class="panel">
    <div class="topbar"><button class="x" onclick="closeModal()">Cerrar ✕</button></div>
    <div id="detail"></div>
  </div>
</div>

<div class="nav-bottom" role="navigation" aria-label="Navegación">
  <button id="navBack" class="nav-btn secondary" onclick="navBack()" aria-label="Atrás">← Atrás</button>
  <button id="navHome" class="nav-btn secondary" onclick="navHome()" aria-label="Inicio">Inicio</button>
  <button id="navFwd"  class="nav-btn primary"  onclick="navForward()" aria-label="Adelante">Adelante →</button>
</div>

<script>
var CHUNK = 9;
['gesturestart','gesturechange','gestureend'].forEach(function(evt){
  document.addEventListener(evt, function(e){ e.preventDefault(); }, { passive:false });
});

var state = {
  q: '',
  items: [],
  rendered: 0,
  nextOffset: '',
  loading: false,
  view: 'cats',
  category: ''
};

function deleteCookie(name){
  try{
    document.cookie = name + '=; Path=/; Max-Age=0; Expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite:Lax; Secure';
  }catch(_){}
}
async function kick(){
  try{
    localStorage.removeItem('tp_token_v1');
    localStorage.removeItem('tp_sessionId');
    localStorage.removeItem('tp_redirect');
    localStorage.removeItem('tp_email');
    deleteCookie('tp_token_v1'); deleteCookie('tp_redirect'); deleteCookie('tp_email');
    if ('caches' in self){ try { await caches.delete('tp-session'); } catch(_){ } }
  }finally{ window.location.assign('/'); }
}
async function logout(){
  try {
    const email = localStorage.getItem('tp_email');
    if (email) {
      const res = await fetch('/api/auth/logout', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      });
      const result = await res.json();
      if (!result.ok) console.error('Error desde backend:', result.error);
    }
    localStorage.removeItem('tp_token_v1');
    localStorage.removeItem('tp_redirect');
    localStorage.removeItem('tp_email');
    localStorage.removeItem('deviceId');
    deleteCookie('tp_token_v1'); deleteCookie('tp_redirect'); deleteCookie('tp_email');
    if ('caches' in self){ try { await caches.delete('tp-session'); } catch(_){} }
    location.replace('/door.html?force=1');
  } catch (err) { console.error('Error al cerrar sesión:', err); }
}

function showErr(msg){
  var box = document.getElementById('err');
  if(!msg){ box.style.display='none'; box.textContent=''; return; }
  box.textContent = msg; box.style.display='block';
}
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&gt;','>':'&quot;'}[m])); }

function normStr(s){ return String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,''); }
function compareByName(a,b){
  const A = normStr(a.ejercicio || a.nombre || '');
  const B = normStr(b.ejercicio || b.nombre || '');
  if (A < B) return -1; if (A > B) return 1; return 0;
}
function sortItems(){ try { state.items.sort(compareByName); } catch(_){} }
function mergeUnique(existing, incoming){
  const seen = new Map(existing.map(x => [x.id, true]));
  for (const x of incoming) if (!seen.has(x.id)) { existing.push(x); seen.set(x.id,true); }
}

function getCategoryName(x){ return (x.categoria || '').trim(); }
function buildCategoryIndex(){
  const map = new Map();
  for (const it of state.items){
    const name = getCategoryName(it) || 'Sin categoría';
    const key  = normStr(name);
    const cur = map.get(key) || { name, key, count:0 };
    cur.count += 1;
    if (name.length > cur.name.length) cur.name = name;
    map.set(key, cur);
  }
  return Array.from(map.values()).sort((a,b)=> (a.name.localeCompare(b.name, 'es', {sensitivity:'base'})));
}
function renderCategories(){
  const grid = document.getElementById('grid');
  const groups = buildCategoryIndex();
  grid.innerHTML = groups.map(g => (
    '<div class="folder" onclick="selectCategory(\''+escapeHtml(g.name).replace(/'/g,"&#39;")+'\')">'+
      '<div class="name">'+escapeHtml(g.name)+'</div>'+
      '<div class="count">'+g.count+'</div>'+
    '</div>'
  )).join('');
  document.getElementById('more').style.display = state.nextOffset ? 'inline-block' : 'none';
  document.getElementById('chipFilter').style.display = 'none';
  if (state.nextOffset) prefetchAllPagesInBackground();
}

function card(x){
  var nombre = escapeHtml(x.ejercicio || x.nombre || '');
  var cat = x.categoria ? '<span class="chip">'+escapeHtml(x.categoria)+'</span>' : '';
  var indHtml = formatIndicaciones3(x.indicaciones || x.descripcion || '');
  var btnVid = x.video
    ? '<a class="btn primary" href="'+x.video+'" target="_blank" rel="noopener">Abrir vídeo ↗</a>'
    : '<span class="btn ghost" style="opacity:.7;cursor:not-allowed">Sin vídeo</span>';
  return ''+
    '<div class="card">'+
      '<div class="card-body">'+
        '<div class="title">'+nombre+'</div>'+
        (cat?'<div>'+cat+'</div>':'')+
        '<div class="section"><div class="desc">'+indHtml+'</div></div>'+
      '</div>'+
      '<div class="actions">'+
        btnVid+
        '<button class="btn ghost" type="button" onclick="openDetail(\''+x.id+'\')">Detalle</button>'+
      '</div>'+
    '</div>';
}
function resetGrid(){ document.getElementById('grid').innerHTML = ''; state.rendered = 0; }
function setMoreVisibility(){
  var more = (state.rendered < filteredItems().length) || !!state.nextOffset;
  document.getElementById('more').style.display = more ? 'inline-block' : 'none';
}
function filteredItems(){
  if (state.view !== 'list') return state.items;
  if (!state.category) return state.items;
  const key = normStr(state.category);
  return state.items.filter(x => normStr(getCategoryName(x)) === key);
}
function renderRange(from, to){
  const arr = filteredItems();
  if (from >= to) return;
  const slice = arr.slice(from, to);
  if (!slice.length) return;
  const html = slice.map(card).join('');
  document.getElementById('grid').insertAdjacentHTML('beforeend', html);
  state.rendered = to;
  setMoreVisibility();
}
function renderInitial(){ renderRange(0, Math.min(CHUNK, filteredItems().length)); }
function renderMore(){ renderRange(state.rendered, Math.min(state.rendered + CHUNK, filteredItems().length)); }

function getToken(){ try { return localStorage.getItem('tp_token_v1') || ''; } catch { return ''; } }
async function apiList(opts){
  const qs = new URLSearchParams({
    q: opts.q || '',
    offset: opts.offset || '',
    pageSize: '100'
  });
  const r  = await fetch('/api/ejercicios?' + qs.toString(), {
    headers: { 'Authorization': 'Bearer ' + getToken() },
    credentials:'include'
  });
  if (r.status === 401) { kick(); throw new Error('HTTP 401'); }
  if (!r.ok) throw new Error('HTTP '+r.status);
  return r.json();
}
async function apiDetail(id){
  const r = await fetch('/api/ejercicios?id=' + encodeURIComponent(id), {
    headers: { 'Authorization': 'Bearer ' + getToken() },
    credentials:'include'
  });
  if (r.status === 401) { kick(); throw new Error('HTTP 401'); }
  if (!r.ok) throw new Error('HTTP '+r.status);
  return r.json();
}

let prefetchingAll = false;
async function prefetchAllPagesInBackground(){
  if (prefetchingAll) return;
  prefetchingAll = true;
  try {
    while (state.nextOffset) {
      await fetchData({ offset: state.nextOffset, append: true, __bg:true });
      if (state.view === 'cats') renderCategories();
      await new Promise(r => setTimeout(r, 50));
    }
  } finally {
    prefetchingAll = false;
  }
}

function pushHistory(){
  const idx = (parseInt(sessionStorage.getItem('tp_nav_idx')||'0',10) || 0) + 1;
  const snap = { idx, view: state.view, category: state.category, q: state.q };
  history.pushState(snap, '', location.pathname + location.search);
  sessionStorage.setItem('tp_nav_idx', String(idx));
  const max = Math.max(idx, parseInt(sessionStorage.getItem('tp_nav_max')||'0',10) || 0);
  sessionStorage.setItem('tp_nav_max', String(max));
  updateNavButtons();
}
function replaceHistory(){
  const idx = parseInt(sessionStorage.getItem('tp_nav_idx')||'0',10) || 0;
  const snap = { idx, view: state.view, category: state.category, q: state.q };
  history.replaceState(snap, '', location.pathname + location.search);
  const max = Math.max(idx, parseInt(sessionStorage.getItem('tp_nav_max')||'0',10) || 0);
  sessionStorage.setItem('tp_nav_max', String(max));
  updateNavButtons();
}
window.addEventListener('popstate', (ev)=>{
  const s = ev.state || { idx:0, view:'cats', category:'', q:'' };
  sessionStorage.setItem('tp_nav_idx', String(s.idx||0));
  state.view = s.view || 'cats';
  state.category = s.category || '';
  state.q = s.q || '';
  const qInput = document.getElementById('q'); if (qInput) qInput.value = state.q;
  resetGrid();
  if (state.view === 'cats'){ renderCategories(); }
  else { renderInitial(); setMoreVisibility(); }
  updateNavButtons();
});

/* === IMPORTANTE: nunca deshabilitamos Atrás para permitir salir a portada === */
function updateNavButtons(){
  const idx = parseInt(sessionStorage.getItem('tp_nav_idx')||'0',10) || 0;
  const max = parseInt(sessionStorage.getItem('tp_nav_max')||'0',10) || 0;
  const backBtn = document.getElementById('navBack');
  const fwdBtn  = document.getElementById('navFwd');
  if (backBtn) backBtn.disabled = false;             // ← siempre activo
  if (fwdBtn)  fwdBtn.disabled  = (idx >= max);
}

/* === Atrás con fallback a portada si no hay navegación real === */
function navBack(){
  // 0) Si el modal está abierto, lo cerramos primero
  var modal = document.getElementById('modal');
  if (modal && modal.style.display === 'flex'){ closeModal(); return; }

  const beforeIdx = parseInt(sessionStorage.getItem('tp_nav_idx')||'0',10) || 0;
  let popped = false;

  const onPop = () => { popped = true; window.removeEventListener('popstate', onPop); };
  window.addEventListener('popstate', onPop, { once:true });

  if (beforeIdx > 0) {
    history.back();
  } else {
    // Sin historial interno → salimos ya
    window.location.assign('/');
    return;
  }

  // Fallback: si en ~350ms no “pasa nada”, vamos a portada
  setTimeout(function(){
    const curIdx = parseInt(sessionStorage.getItem('tp_nav_idx')||'0',10) || 0;
    const atRootView = (state.view === 'cats' && !state.q && !state.category);
    const noProgress = (!popped || curIdx >= beforeIdx);
    if (noProgress || (atRootView && curIdx === 0)) {
      window.location.assign('/');
    }
  }, 350);
}

function navForward(){ history.forward(); }
function navHome(){
  state.q = '';
  state.view = 'cats';
  state.category = '';
  try { document.getElementById('q').value = ''; } catch(_){}
  document.getElementById('chipFilter').style.display = 'none';
  resetGrid(); renderCategories();
  pushHistory();
}

async function fetchData(opts){
  opts = opts || {};
  if (state.loading) return;
  state.loading = true; showErr('');

  const prevRendered = state.rendered;
  const prevScrollY = window.scrollY;

  try{
    const res = await apiList({
      q: (typeof opts.q!=='undefined' ? opts.q : state.q),
      offset: (opts.offset || '')
    });
    const rows = (res && Array.isArray(res.rows)) ? res.rows : [];

    if (!opts.append){
      state.items = rows.slice();
      state.nextOffset = res.nextOffset || '';
    } else {
      mergeUnique(state.items, rows);
      state.nextOffset = res.nextOffset || '';
    }

    sortItems();

    if (!state.q) { state.view = 'cats'; state.category = ''; }

    resetGrid();
    if (state.view === 'cats') {
      renderCategories();
    } else {
      const target = Math.max(CHUNK, prevRendered);
      renderRange(0, Math.min(target, filteredItems().length));
      try { window.scrollTo(0, prevScrollY); } catch(_){}
    }

  }catch(err){
    if (String(err).includes('401')) return;
    showErr('Error cargando datos: ' + String(err.message || err));
  }finally{
    state.loading = false;
  }
}

function selectCategory(name){
  state.view = 'list';
  state.category = name || '';
  document.getElementById('chipFilter').style.display = state.category ? 'inline-flex' : 'none';
  document.getElementById('chipLabel').textContent = 'Categoría: ' + (state.category || '—');
  resetGrid(); renderInitial(); setMoreVisibility();
  pushHistory();
}
function clearCategory(){
  state.category = '';
  document.getElementById('chipFilter').style.display = 'none';
  if (!state.q) {
    state.view = 'cats'; resetGrid(); renderCategories();
  } else {
    resetGrid(); renderInitial(); setMoreVisibility();
  }
  pushHistory();
}
function cargarMasUI(){
  if (state.view === 'cats') {
    if (state.nextOffset && !state.loading) fetchData({ q: state.q, offset: state.nextOffset, append: true });
  } else {
    const arr = filteredItems();
    if (state.rendered < arr.length) renderMore();
    else if (state.nextOffset && !state.loading) fetchData({ q: state.q, offset: state.nextOffset, append: true });
  }
}
function buscar(){
  const input = document.getElementById('q');
  state.q = (input.value || '').trim();
  state.view = state.q ? 'list' : 'cats';
  fetchData({ q: state.q }).then(()=>{
    if (state.view === 'cats' && state.nextOffset) prefetchAllPagesInBackground();
    pushHistory();
  });
}
function limpiar(){
  const input = document.getElementById('q');
  input.value='';
  state.q=''; state.view='cats'; state.category='';
  document.getElementById('chipFilter').style.display = 'none';
  fetchData({ q:'' }).then(()=>{
    if (state.nextOffset) prefetchAllPagesInBackground();
    pushHistory();
  });
}

function formatIndicaciones(text){
  if(!text) return '';
  var parts = String(text).split(/(?=\d+\.\s)/g).map(function(x){ return x.trim(); }).filter(Boolean);
  if(parts.length <= 1) return '<div class="line">'+escapeHtml(text)+'</div>';
  return parts.map(function(p){ return '<div class="line">'+escapeHtml(p)+'</div>'; }).join('');
}
function formatIndicaciones3(text){
  if(!text) return '';
  var raw = String(text).trim();
  raw = raw.replace(/\r/g,'\n').replace(/[•\u2022\u2023\u25E6]/g,'\n').replace(/[;·]/g,'\n').replace(/\s*[-–—]\s+/g,'\n');
  raw = raw.replace(/(^|\s)(\d+[.)]\s+)/g,'\n$2').replace(/([.!?])\s+([A-ZÁÉÍÓÚÑ0-9])/g,'$1\n$2');
  var parts = raw.split(/\n+/).map(function(p){ return p.trim(); }).filter(Boolean);
  var merged = [], i;
  for(i=0;i<parts.length;i++){
    var cur = parts[i];
    if(/^\d+[.)]$/.test(cur) && i+1<parts.length){ merged.push(cur + ' ' + parts[i+1]); i++; }
    else { merged.push(cur); }
  }
  function esc(s){ return (s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&gt;','>':'&quot;'}[m])); }
  return merged.slice(0,3).map(function(p){ return '<div class="line">'+esc(p)+'</div>'; }).join('');
}

function openDetail(id){
  const modal = document.getElementById('modal');
  const box   = document.getElementById('detail');
  box.innerHTML = '<div class="detail-title">Cargando…</div>';
  modal.style.display = 'flex';
  loadDetail(id).catch(err=>{
    box.innerHTML = '<div class="detail-title">No se pudo cargar</div><div class="detail-body">'+escapeHtml(String(err && err.message || err))+'</div>';
  });
}
async function loadDetail(id){
  const r = await apiDetail(id);
  const d = r && r.detail;
  const nombre = (d && (d.nombre || d.ejercicio)) || 'Ejercicio';
  const cat    = (d && d.categoria) ? d.categoria : '';
  const ind    = (d && (d.descripcion || d.indicaciones)) || '';

  const html =
    '<div class="detail-title">'+escapeHtml(nombre)+'</div>'+
    (cat ? '<div class="detail-chip">'+escapeHtml(cat)+'</div>' : '')+
    '<div class="detail-body">'+formatIndicaciones(ind)+'</div>';

  document.getElementById('detail').innerHTML = html;
}
function closeModal(){ document.getElementById('modal').style.display = 'none'; }

document.addEventListener('DOMContentLoaded', async function(){
  try { document.getElementById('q').value = ''; } catch(_){}
  state.q = ''; state.view = 'cats'; state.category = '';
  document.getElementById('chipFilter').style.display = 'none';

  if (sessionStorage.getItem('tp_nav_idx') === null){
    sessionStorage.setItem('tp_nav_idx','0');
    sessionStorage.setItem('tp_nav_max','0');
  }
  replaceHistory();

  await fetchData();
  if (state.view === 'cats' && state.nextOffset) prefetchAllPagesInBackground();

  updateNavButtons();
});
window.addEventListener('pageshow', function(e){ if (e.persisted) { fetchData(); updateNavButtons(); }});
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });
</script>

<script>
(async function guard(){
  const token = localStorage.getItem('tp_token_v1') || '';
  if (!token) { kick(); return; }
  const ok = await check(token);
  if (!ok) { kick(); return; }
  setInterval(async ()=>{
    const tok = localStorage.getItem('tp_token_v1') || '';
    if (!tok || !(await check(tok))) kick();
  }, 5 * 60 * 1000);
  document.addEventListener('visibilitychange', async () => {
    if (document.visibilityState === 'visible') {
      const tok = localStorage.getItem('tp_token_v1') || '';
      if (!tok || !(await check(tok))) kick();
    }
  });
})();
async function check(token){
  try{
    const r = await fetch('/api/auth/check', {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'Authorization': 'Bearer ' + token },
      body: JSON.stringify({ token })
    });
    return r.ok;
  }catch{ return false; }
}
function kick(){
  try{
    localStorage.removeItem('tp_token_v1');
    localStorage.removeItem('tp_sessionId');
  }catch{}
  window.location.assign('/index.html'); // portada
}
</script>
</body>
</html>
