<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>Acceso a Biblioteca</title>
<link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{ --bg:#000; --panel:#0c0c0c; --line:#1c1c1c; --fg:#fff; --gold:#E6C06E; --muted:#bdbdbd; }
  *{box-sizing:border-box}
 html,body{
  margin:0;
  background:var(--bg);
  color:var(--fg);
  font-family:"Libre Baskerville",serif;
  font-size:15px;
  line-height:1.6;
  -webkit-text-size-adjust:100%;
}
  .wrap{max-width:720px;margin:0 auto;padding:28px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:20px; box-shadow:0 8px 28px rgba(0,0,0,.25)}
  h1{
  margin:0 0 10px;
  font-weight:700;
  font-size:22px;
  font-family:"Libre Baskerville",serif;
}

p,
.muted,
.detail{
  font-family:"Libre Baskerville",serif;
}

input{
  flex:1 1 auto;
  min-width:0;
  display:block;
  width:100%;
  padding:12px 14px;
  border-radius:12px;
  border:1px solid #dcdcdc;              /* borde gris clarito */
  background:#ffffff;                     /* fondo blanco */
  color:#000000;                          /* texto negro */
  font-size:16px;
  font-family:"Libre Baskerville",serif;
  -webkit-appearance:none;
  appearance:none;
}

input::placeholder{
  color:#777;
}

button{
  flex:0 0 auto;
  padding:10px 16px;
  border-radius:12px;
  border:1px solid var(--gold);
  background:linear-gradient(180deg, #f0d9a1 0%, var(--gold) 45%, #d3ab5c 100%);
  color:#000;
  cursor:pointer;
  font-weight:700;
  font-size:14px;
  font-family:"Libre Baskerville",serif;
  -webkit-appearance:none;
  appearance:none;
}

button:active{
  transform:translateY(1px);
  box-shadow:0 2px 6px rgba(0,0,0,.4) inset;
}

  .msg{margin-top:10px; min-height:18px; white-space:pre-wrap}
  .muted{color:var(--muted);font-size:13px}
  .hide{display:none}
  .detail{margin-top:6px; color:#b5b5b5; font-size:12px; white-space:pre-wrap}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="form">
      <h1>Accede a tu biblioteca</h1>
      <p>Introduce tu email de compra para validar el acceso.</p>

      <div class="row">
        <input id="email" type="email" placeholder="tu@email.com" autocomplete="email" inputmode="email">
        <button id="btn">Entrar</button>
      </div>

      <div class="msg" id="msg"></div>
      <pre class="detail hide" id="detail"></pre>
      <p class="muted" id="loading" style="display:none">Validando…</p>
    </div>

    <div class="card hide" id="checking">
      <h1>Comprobando sesión…</h1>
      <p class="muted">Un momento, por favor.</p>
    </div>
  </div>

<script>
/* ================== config ================== */
const DEFAULT_REDIR = '/interfaz/';

/* ================== helpers ================== */
const $ = (s)=>document.querySelector(s);
const BASE = new URL('.', location.href);
const url  = (rel) => new URL(rel, BASE).toString();
const SESSION_URL = url('session');
const usp = new URLSearchParams(location.search);
const DEBUG = usp.has('debug');

function getCookie(name){
  const v=('; '+document.cookie).split('; '+name+'='); return v.length>1 ? decodeURIComponent(v.pop().split(';').shift()||'') : '';
}
function setCookie(name, value, maxAgeSec){
  const exp = new Date(Date.now()+maxAgeSec*1000).toUTCString();
  document.cookie = name+'='+encodeURIComponent(value)+'; Path=/; Max-Age='+maxAgeSec+'; Expires='+exp+'; SameSite=Lax; Secure';
}
function delCookie(name){
  document.cookie = name + '=; Path=/; Max-Age=0; Expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax; Secure';
}
function showForm(){ $('#checking').classList.add('hide'); $('#form').classList.remove('hide'); }
function showChecking(){ $('#form').classList.add('hide'); $('#checking').classList.remove('hide'); }
function showError(msg, detail){
  $('#msg').textContent = msg || '';
  if (DEBUG && detail){
    const d = $('#detail');
    d.textContent = String(detail || '');
    d.classList.remove('hide');
  } else {
    $('#detail').classList.add('hide');
    $('#detail').textContent = '';
  }
}

function deviceId() {
  try{
    const k='tp_device_id';
    let id = localStorage.getItem(k);
    if (!id) {
      id = (crypto.randomUUID && crypto.randomUUID()) || Math.random().toString(36).slice(2) + Date.now().toString(36);
      localStorage.setItem(k, id);
    }
    return id;
  }catch(_){ return 'web'; }
}

async function restoreFromCache(){
  try{
    if(!('caches' in self)) return null;
    const cache = await caches.open('tp-session');
    const res = await cache.match(SESSION_URL);
    if(!res) return null;
    const { token, redirect, email } = await res.json();
    if(!(token && redirect)) return null;
    const Y = 60*60*24*365;
    localStorage.setItem('tp_token_v1', token);
    localStorage.setItem('tp_redirect', redirect);
    if (email) localStorage.setItem('tp_email', email);
    setCookie('tp_token_v1', token, Y);
    setCookie('tp_redirect', redirect, Y);
    if (email) setCookie('tp_email', email, Y);
    return { token, redirect, email: email||'' };
  }catch{ return null; }
}

/* ====== NUEVO: validación online del token y limpieza dura ====== */
async function validateTokenOnline(token){
  try{
    const r = await fetch('/api/auth/check', {
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+token },
      body: JSON.stringify({ token })
    });
    return r.ok;
  }catch{ return false; }
}
async function hardClearSessionResidue(){
  try{
    localStorage.removeItem('tp_token_v1');
    localStorage.removeItem('tp_redirect');
    localStorage.removeItem('tp_email');
  }catch{}
  delCookie('tp_token_v1'); delCookie('tp_redirect'); delCookie('tp_email');
  if ('caches' in self){
    try { await caches.delete('tp-session'); } catch(_){}
  }
}

/* ================== init (autologin si hay sesión) ================== */
(async function init(){
  const force = usp.has('force');
  const redirectPref = usp.get('redirect') || '';

  const savedEmail = localStorage.getItem('tp_email') || getCookie('tp_email') || '';
  if (savedEmail) $('#email').value = savedEmail;

  if (force) { showForm(); return; }
  showChecking();

  let tk = localStorage.getItem('tp_token_v1') || getCookie('tp_token_v1') || '';
  let redir = localStorage.getItem('tp_redirect') || getCookie('tp_redirect') || '';
  if (!(tk && redir)) {
    const r = await restoreFromCache();
    if (r) { tk = r.token; redir = r.redirect; }
  }
  const finalRedir = (redirectPref || redir || '').trim();

  if (tk && finalRedir && finalRedir !== '/') {
    // ✅ Comprobar que el token sigue siendo válido (no borrado en SESSIONS)
    const ok = await validateTokenOnline(tk);
    if (ok) {
      location.replace(finalRedir); // pasa directo si sigue válido
      return;
    } else {
      // ❌ Token inválido → limpia residuos y muestra el form
      await hardClearSessionResidue();
    }
  }

  showForm();
})();

/* ================== login (1 sesión por email) ================== */
async function doLogin(){
  const email = ($('#email').value||'').trim().toLowerCase();
  if(!email){ showError('Escribe tu email'); return; }
  $('#loading').style.display='block'; showError('');

  try{
    const r = await fetch('/api/auth/login' + (DEBUG ? '?debug=1' : ''), {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ email, deviceId: deviceId() })
    });

    let data = {};
    try { data = await r.json(); } catch {}

    if (!r.ok || !data.ok) {
      const msg = (data && data.error) ? data.error : `Error HTTP ${r.status}`;
      const detail = (data && data.detail) ? data.detail : '';
      showError(msg, detail);
      return;
    }

    // Guarda mínimo para la navegación inmediata
    try{
      localStorage.setItem('tp_email', email);
      if (data.sessionId) localStorage.setItem('tp_sessionId', data.sessionId);
      localStorage.setItem('tp_token_v1', data.token);
      localStorage.setItem('tp_redirect', data.redirect || DEFAULT_REDIR);
    }catch(_){}

    // Redirección a save.html (guarda cookies + cache + redirige)
    const redirectPref = new URLSearchParams(location.search).get('redirect') || '';
    const finalRedir = redirectPref || data.redirect || DEFAULT_REDIR;
    const p = new URLSearchParams({ tk:data.token, redir:finalRedir, email });
    location.replace('/save.html?'+p.toString());

  }catch(e){
    showError('Error de red. Inténtalo de nuevo.', String(e && e.message || e));
  }finally{
    $('#loading').style.display='none';
  }
}

/* click + Enter */
$('#btn').addEventListener('click', doLogin);
$('#email').addEventListener('keydown', (e)=>{ if (e.key === 'Enter') doLogin(); });
</script>
</body>
</html>
