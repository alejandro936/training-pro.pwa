<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>DiagnÃ³stico de sesiÃ³n</title>
  <style>
    body {
      font-family: sans-serif;
      background: #000;
      color: #fff;
      padding: 20px;
    }
    h1 { font-size: 1.5em; margin-bottom: 10px; }
    pre { background: #111; padding: 10px; border-radius: 6px; overflow-x: auto; }
    .ok { color: #0f0; }
    .fail { color: #f33; }
  </style>
</head>
<body>
  <h1>ğŸ” DiagnÃ³stico de sesiÃ³n</h1>
  <div id="output"><pre>Cargandoâ€¦</pre></div>

  <script>
    const VALIDATION_ENDPOINT = 'https://script.google.com/macros/s/AKfycbz8d_Zx_iK2Yn8ojMQGjrTigZIKlGpKyM_ln4-zFAeG7vL62550SdHa-szs3ZEAui8E/exec';

    async function runDiagnostics() {
      const out = [];
      const email = localStorage.getItem('tp_email');
      const token = localStorage.getItem('tp_token_v1');
      const redir = localStorage.getItem('tp_redirect');

      out.push(`ğŸ“§ Email en localStorage: ${email ? email : '[NO GUARDADO]'}`);
      out.push(`ğŸ”‘ Token en localStorage: ${token ? token : '[NO GUARDADO]'}`);
      out.push(`â¡ï¸ RedirecciÃ³n en localStorage: ${redir ? redir : '[NO GUARDADO]'}`);

      // Cookies
      const cookies = document.cookie;
      out.push(`ğŸª Cookies: ${cookies || '[VACÃAS]'}`);

      // CacheStorage
      try {
        const cache = await caches.open('tp-session');
        const res = await cache.match('/session');
        if (res) {
          const data = await res.json();
          out.push(`ğŸ“¦ CacheStorage: token=${data.token}, redirect=${data.redirect}`);
        } else {
          out.push(`ğŸ“¦ CacheStorage: [NO ENCONTRADO]`);
        }
      } catch (e) {
        out.push(`ğŸ“¦ CacheStorage: âŒ Error`);
      }

      // IndexedDB
      try {
        const req = indexedDB.open('tp_session', 1);
        req.onsuccess = function (e) {
          const db = e.target.result;
          const tx = db.transaction('auth', 'readonly');
          const store = tx.objectStore('auth');
          const getReq = store.get('session');
          getReq.onsuccess = function () {
            const result = getReq.result;
            if (result) {
              out.push(`ğŸ—ƒï¸ IndexedDB: token=${result.token}, redirect=${result.redirect}`);
            } else {
              out.push(`ğŸ—ƒï¸ IndexedDB: [NO ENCONTRADO]`);
            }
            checkServer(email, out);
          };
          getReq.onerror = function () {
            out.push(`ğŸ—ƒï¸ IndexedDB: âŒ Error`);
            checkServer(email, out);
          };
        };
        req.onerror = function () {
          out.push(`ğŸ—ƒï¸ IndexedDB: âŒ Error al abrir`);
          checkServer(email, out);
        };
      } catch (e) {
        out.push(`ğŸ—ƒï¸ IndexedDB: âŒ Error general`);
        checkServer(email, out);
      }
    }

    async function checkServer(email, out) {
      if (!email) {
        out.push(`ğŸŒ ValidaciÃ³n remota: [NO SE PUEDE CONSULTAR SIN EMAIL]`);
        document.getElementById('output').innerHTML = `<pre>${out.join('\n')}</pre>`;
        return;
      }

      try {
        const res = await fetch(VALIDATION_ENDPOINT + '?email=' + encodeURIComponent(email));
        const data = await res.json();
        if (data.valid) {
          out.push(`ğŸŒ ValidaciÃ³n remota: âœ… token=${data.token}, redirect=${data.redirect}`);
        } else {
          out.push(`ğŸŒ ValidaciÃ³n remota: âŒ SesiÃ³n no encontrada`);
        }
      } catch (e) {
        out.push(`ğŸŒ ValidaciÃ³n remota: âŒ Error de red`);
      }

      document.getElementById('output').innerHTML = `<pre>${out.join('\n')}</pre>`;
    }

    runDiagnostics();
  </script>
</body>
</html>
