<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Diagnóstico de sesión</title>
  <style>
    body {
      font-family: sans-serif;
      background: #000;
      color: #fff;
      padding: 20px;
    }
    h1 { font-size: 1.5em; margin-bottom: 10px; }
    pre { background: #111; padding: 10px; border-radius: 6px; overflow-x: auto; white-space: pre-wrap; }
    .ok { color: #0f0; }
    .fail { color: #f33; }
  </style>
</head>
<body>
  <h1>🔍 Diagnóstico de sesión</h1>
  <div id="output"><pre>Cargando…</pre></div>

  <script>
    const VALIDATION_ENDPOINT = 'https://script.google.com/macros/s/AKfycbz8d_Zx_iK2Yn8ojMQGjrTigZIKlGpKyM_ln4-zFAeG7vL62550SdHa-szs3ZEAui8E/exec';

    async function runDiagnostics() {
      const out = [];

      // LocalStorage
      const email = localStorage.getItem('tp_email');
      const token = localStorage.getItem('tp_token_v1');
      const redir = localStorage.getItem('tp_redirect');
      out.push(`📧 Email en localStorage: ${email || '[NO GUARDADO]'}`);
      out.push(`🔑 Token en localStorage: ${token || '[NO GUARDADO]'}`);
      out.push(`➡️ Redirección en localStorage: ${redir || '[NO GUARDADO]'}`);

      // Cookies
      out.push(`🍪 Cookies: ${document.cookie || '[VACÍAS]'}`);

      // CacheStorage
      try {
        const cache = await caches.open('tp-session');
        const res = await cache.match('/session');
        if (res) {
          const data = await res.json();
          out.push(`📦 CacheStorage: token=${data.token}, redirect=${data.redirect}`);
        } else {
          out.push(`📦 CacheStorage: [NO ENCONTRADO]`);
        }
      } catch (e) {
        out.push(`📦 CacheStorage: ❌ Error`);
      }

      // IndexedDB
      try {
        const dbReq = indexedDB.open('tp_session', 1);
        dbReq.onsuccess = function (e) {
          try {
            const db = e.target.result;
            const tx = db.transaction('auth', 'readonly');
            const store = tx.objectStore('auth');
            const getReq = store.get('session');
            getReq.onsuccess = function () {
              const result = getReq.result;
              if (result) {
                out.push(`🗃️ IndexedDB: token=${result.token}, redirect=${result.redirect}`);
              } else {
                out.push(`🗃️ IndexedDB: [NO ENCONTRADO]`);
              }
              checkServer(email, out);
            };
            getReq.onerror = function () {
              out.push(`🗃️ IndexedDB: ❌ Error al leer`);
              checkServer(email, out);
            };
          } catch (err) {
            out.push(`🗃️ IndexedDB: ❌ Error interno`);
            checkServer(email, out);
          }
        };
        dbReq.onerror = function () {
          out.push(`🗃️ IndexedDB: ❌ Error al abrir`);
          checkServer(email, out);
        };
      } catch (e) {
        out.push(`🗃️ IndexedDB: ❌ Error general`);
        checkServer(email, out);
      }
    }

    async function checkServer(email, out) {
      if (!email) {
        out.push(`🌐 Validación remota: [NO SE PUEDE CONSULTAR SIN EMAIL]`);
        document.getElementById('output').innerHTML = `<pre>${out.join('\n')}</pre>`;
        return;
      }

      try {
        const res = await fetch(VALIDATION_ENDPOINT + '?email=' + encodeURIComponent(email));
        const data = await res.json();
        if (data.valid) {
          out.push(`🌐 Validación remota: ✅ token=${data.token}, redirect=${data.redirect}`);
        } else {
          out.push(`🌐 Validación remota: ❌ Sesión no encontrada`);
        }
      } catch (e) {
        out.push(`🌐 Validación remota: ❌ Error de red`);
      }

      document.getElementById('output').innerHTML = `<pre>${out.join('\n')}</pre>`;
    }

    runDiagnostics();
  </script>
</body>
</html>
