<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Entrando‚Ä¶</title>

  <!-- Iconos para instalaci√≥n en iOS -->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/apple-touch-icon-167.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120.png">

  <!-- Manifest para Android/Chrome -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#000000">
</head>
<body></body>

<script>
  // Funci√≥n para leer cookies
  function readCookie(name) {
    const cookie = document.cookie.split('; ').find(c => c.startsWith(name + '='));
    return cookie ? decodeURIComponent(cookie.split('=')[1]) : '';
  }

  // Funci√≥n para leer desde IndexedDB
  function readFromIDB(keys, callback) {
    try {
      const request = indexedDB.open('tpdb', 1);
      request.onupgradeneeded = e => e.target.result.createObjectStore('kv');
      request.onsuccess = () => {
        const db = request.result;
        const tx = db.transaction('kv', 'readonly');
        const store = tx.objectStore('kv');
        const result = {};
        let remaining = keys.length;

        keys.forEach(key => {
          const getReq = store.get(key);
          getReq.onsuccess = () => {
            result[key] = getReq.result || '';
            if (--remaining === 0) callback(result);
          };
          getReq.onerror = () => {
            result[key] = '';
            if (--remaining === 0) callback(result);
          };
        });
      };
      request.onerror = () => callback({});
    } catch (err) {
      console.warn('IndexedDB error:', err);
      callback({});
    }
  }

  // L√≥gica principal
  (function () {
    const keys = ['tp_token_v1', 'tp_redirect'];

    // Paso 1: Intentar desde localStorage
    let token = localStorage.getItem('tp_token_v1') || '';
    let redirect = localStorage.getItem('tp_redirect') || '';

    // Paso 2: Si no hay datos, intentar desde cookies
    if (!token || !redirect) {
      token = token || readCookie('tp_token_v1');
      redirect = redirect || readCookie('tp_redirect');
    }

    // Paso 3: Si a√∫n no hay datos, intentar desde IndexedDB
    if (!token || !redirect) {
      readFromIDB(keys, data => {
        token = token || data.tp_token_v1 || '';
        redirect = redirect || data.tp_redirect || '';

        console.log('üîê Token:', token);
        console.log('‚û°Ô∏è Redirecci√≥n:', redirect);

        if (token && redirect) {
          location.replace(redirect);
        } else {
          location.replace('https://script.google.com/macros/s/AKfycbzQmsWA0CdVjdKzXHTSJeNhWFfvou-ffyL_cWQ73piWaakxZ8fv7Z9KPXdvDNae9xEY2A/exec');
        }
      });
    } else {
      console.log('üîê Token:', token);
      console.log('‚û°Ô∏è Redirecci√≥n:', redirect);

      if (token && redirect) {
        location.replace(redirect);
      } else {
        location.replace('https://script.google.com/macros/s/AKfycbzQmsWA0CdVjdKzXHTSJeNhWFfvou-ffyL_cWQ73piWaakxZ8fv7Z9KPXdvDNae9xEY2A/exec');
      }
    }
  })();
</script>
