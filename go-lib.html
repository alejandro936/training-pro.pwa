<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Training Pro — Accediendo…</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<style>
  body{margin:0;background:#0b0d12;color:#fff;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{min-height:100dvh;display:grid;place-items:center;padding:32px}
  .card{max-width:640px;width:100%;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:24px}
  h1{font-weight:800;font-size:24px;margin:0 0 10px}
  p{opacity:.8;line-height:1.6;margin:0}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Validando acceso…</h1>
      <p>Un momento, por favor.</p>
    </div>
  </div>

<script>
/* ================== BASE & URL HELPERS ================== */
const BASE = new URL('.', location.href);
const url  = (rel) => new URL(rel, BASE).toString();
const DOOR_URL    = 'door.html';
const SESSION_URL = url('session');
const VALIDATION_ENDPOINT = url('api/validate-token'); // ajusta si tu API vive en otro dominio

function toAbsMaybe(p){
  try{ return p && !/^https?:\/\//i.test(p) ? url(p) : p; }catch{ return p; }
}

/* ====== Cookies ====== */
function setCookie(name, value, maxAgeSec){
  const exp = new Date(Date.now() + maxAgeSec*1000).toUTCString();
  document.cookie = name + '=' + encodeURIComponent(value)
    + '; path=' + BASE.pathname
    + '; max-age=' + maxAgeSec
    + '; expires=' + exp
    + '; SameSite=Lax; Secure';
}
function getCookie(name){
  const v = ('; '+document.cookie).split('; '+name+'=');
  return v.length>1 ? decodeURIComponent(v.pop().split(';').shift()||'') : '';
}

/* ====== Rescate CacheStorage ====== */
async function restoreFromCache(){
  try{
    if(!('caches' in self)) return false;
    const cache = await caches.open('tp-session');
    const res = await cache.match(SESSION_URL);
    if(!res) return false;
    const { token, redirect, email } = await res.json();
    if(!(token && redirect && email)) return false;

    localStorage.setItem('tp_token_v1', token);
    localStorage.setItem('tp_redirect', redirect);
    localStorage.setItem('tp_email', email);

    const ONE_YEAR = 60*60*24*365;
    setCookie('tp_token_v1', token, ONE_YEAR);
    setCookie('tp_redirect', redirect, ONE_YEAR);
    setCookie('tp_email', email, ONE_YEAR);
    return true;
  }catch(e){
    console.warn('restoreFromCache error', e);
    return false;
  }
}

async function main(){
  let tk    = localStorage.getItem('tp_token_v1') || getCookie('tp_token_v1') || '';
  let redir = localStorage.getItem('tp_redirect') || getCookie('tp_redirect') || '';
  let email = localStorage.getItem('tp_email')    || getCookie('tp_email')    || '';

  if (!(tk && redir && email)) {
    const restored = await restoreFromCache();
    if (restored) {
      tk    = localStorage.getItem('tp_token_v1') || '';
      redir = localStorage.getItem('tp_redirect') || '';
      email = localStorage.getItem('tp_email')    || '';
    }
  }

  if (tk && redir && redir !== '/') {
    location.replace(toAbsMaybe(redir));
    return;
  }

  if (!email) {
    location.replace(DOOR_URL);
    return;
  }

  // Validar token contra servidor (si existe)
  try{
    const r = await fetch(VALIDATION_ENDPOINT, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'include',
      body: JSON.stringify({ token: tk, email })
    });

    if (r.ok) {
      const data = await r.json(); // { ok, redirect, token? }
      if (data && data.ok && data.redirect) {
        const token = data.token || tk || '';
        const redirect = data.redirect;

        localStorage.setItem('tp_redirect', redirect);
        if (token) localStorage.setItem('tp_token_v1', token);

        const ONE_YEAR = 60*60*24*365;
        if (token) setCookie('tp_token_v1', token, ONE_YEAR);
        setCookie('tp_redirect', redirect, ONE_YEAR);

        if ('caches' in self) {
          const cache = await caches.open('tp-session');
          await cache.put(SESSION_URL, new Response(JSON.stringify({
            token: token || null,
            redirect,
            email
          }), { headers:{'Content-Type':'application/json'} }));
        }

        location.replace(toAbsMaybe(redirect));
        return;
      }
    } else {
      // Si el endpoint no existe (404), continúa con lo que tengamos local
      if (r.status === 404 && redir) {
        location.replace(toAbsMaybe(redir));
        return;
      }
    }
  }catch(e){
    console.warn('validate error', e);
    // Si hay redirect local, úsalo
    if (redir) { location.replace(toAbsMaybe(redir)); return; }
  }

  // Fallback
  location.replace(DOOR_URL);
}

main();
</script>
</body>
</html>
