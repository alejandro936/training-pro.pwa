<!doctype html>
<meta charset="utf-8">
<script>
(async function () {
  const DOOR = 'https://script.google.com/macros/s/AKfycby2m0GoCweLlCLbnQVPwFRC3wPOpK3Zd7Qj6dZ55_N2urmatJmTl_6yaXUgWkkPvcY/exec';

  function ckGet(name) {
    const v = ('; ' + document.cookie).split('; ' + name + '=');
    return v.length > 1 ? decodeURIComponent(v.pop().split(';').shift() || '') : '';
  }

  let tk = localStorage.getItem('tp_token_v1') || ckGet('tp_token_v1') || '';
  let redir = localStorage.getItem('tp_redirect') || ckGet('tp_redirect') || '';

  if (tk && redir && redir !== '/') {
    location.replace(redir);
    return;
  }

  // Leer desde CacheStorage
  try {
    const cache = await caches.open('tp-session');
    const res = await cache.match('/session');
    if (res) {
      const data = await res.json();
      if (data.token && data.redirect && data.redirect !== '/') {
        location.replace(data.redirect);
        return;
      }
    }
  } catch (e) {
    console.warn('❌ Error leyendo sesión desde CacheStorage:', e);
  }

  location.replace(DOOR);
})();
</script>
