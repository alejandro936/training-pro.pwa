<!doctype html>
<meta charset="utf-8">
<script>
(function () {
  const DOOR = 'https://script.google.com/macros/s/AKfycby2m0GoCweLlCLbnQVPwFRC3wPOpK3Zd7Qj6dZ55_N2urmatJmTl_6yaXUgWkkPvcY/exec';

  function ckGet(name) {
    const v = ('; ' + document.cookie).split('; ' + name + '=');
    return v.length > 1 ? decodeURIComponent(v.pop().split(';').shift() || '') : '';
  }

  function getSessionFromIndexedDB() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open('tp_session', 1);
      req.onerror = () => reject();
      req.onsuccess = (e) => {
        const db = e.target.result;
        const tx = db.transaction('auth', 'readonly');
        const store = tx.objectStore('auth');
        const getReq = store.get('session');
        getReq.onsuccess = () => resolve(getReq.result || {});
        getReq.onerror = () => reject();
      };
    });
  }

  async function main() {
    let tk = localStorage.getItem('tp_token_v1') || localStorage.getItem('ls_token') || ckGet('tp_token_v1') || '';
    let redir = localStorage.getItem('tp_redirect') || localStorage.getItem('ls_redir') || ckGet('tp_redirect') || '';

    if (tk && redir && redir !== '/') {
      location.replace(redir);
      return;
    }

    try {
      const session = await getSessionFromIndexedDB();
      if (session.token && session.redirect && session.redirect !== '/') {
        location.replace(session.redirect);
      } else {
        location.replace(DOOR);
      }
    } catch {
      location.replace(DOOR);
    }
  }

  main();
})();
</script>
