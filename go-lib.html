<!doctype html>
<meta charset="utf-8">
<title>Entrandoâ€¦</title>
<script>
function readCookie(name){
  return document.cookie.split('; ')
    .find(v => v.startsWith(name + '='))?.split('=')[1] || '';
}

function fromIDB(keys, cb){
  try{
    const req = indexedDB.open('tpdb', 1);
    req.onupgradeneeded = e => e.target.result.createObjectStore('kv');
    req.onsuccess = () => {
      const db = req.result;
      const tx = db.transaction('kv', 'readonly');
      const kv = tx.objectStore('kv');
      const out = {};
      let pending = keys.length;
      keys.forEach(k=>{
        const r = kv.get(k);
        r.onsuccess = () => { out[k] = r.result || ''; if(--pending===0) cb(out); };
        r.onerror   = () => { out[k] = '';            if(--pending===0) cb(out); };
      });
    };
    req.onerror = () => cb({});
  }catch(e){ cb({}); }
}

(function () {
  // 1) Intento con IndexedDB
  fromIDB(['tp_token_v1','tp_redirect'], idb => {
    let tk    = idb.tp_token_v1 || '';
    let redir = idb.tp_redirect || '';

    // 2) Si no hay, pruebo cookie
    if (!tk || !redir) {
      tk    = tk    || decodeURIComponent(readCookie('tp_token_v1') || '');
      redir = redir || decodeURIComponent(readCookie('tp_redirect') || '');
    }
    // 3) Si no hay, pruebo localStorage
    if (!tk || !redir) {
      try{
        tk    = tk    || localStorage.getItem('tp_token_v1') || '';
        redir = redir || localStorage.getItem('tp_redirect') || '';
      }catch(e){}
    }

    // 4) Resultado
    if (tk && redir) {
      location.replace(redir);
    } else {
      // Puerta (Apps Script)
      location.replace('https://script.google.com/macros/s/AKfycbzQmsWA0CdVjdKzXHTSJeNhWFfvou-ffyL_cWQ73piWaakxZ8fv7Z9KPXdvDNae9xEY2A/exec');
    }
  });
})();
</script>
