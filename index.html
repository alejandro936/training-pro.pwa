<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Training Pro — Inicio</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<style>
  body{margin:0;background:#0b0d12;color:#fff;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{min-height:100dvh;display:grid;place-items:center;padding:32px}
  .card{max-width:640px;width:100%;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:24px}
  h1{font-weight:800;font-size:28px;margin:0 0 12px}
  p{opacity:.8;line-height:1.6;margin:0}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Training Pro</h1>
      <p>Cargando…</p>
    </div>
  </div>

<script>
/** ================== CONFIG ================== **/
const DOOR = '/door.html'; // Página donde pides/verificas el email
// Si quieres, pide persistencia de almacenamiento (no afecta si no está soportado)
if (navigator.storage && navigator.storage.persist) {
  navigator.storage.persist().catch(()=>{});
}

/** ====== Utilidades cookies ====== **/
function setCookie(name, value, maxAgeSec){
  const exp = new Date(Date.now() + maxAgeSec*1000).toUTCString();
  document.cookie = name + '=' + encodeURIComponent(value)
    + '; path=/; max-age=' + maxAgeSec
    + '; expires=' + exp
    + '; SameSite=Lax; Secure';
}
function getCookie(name){
  const v = ('; '+document.cookie).split('; '+name+'=');
  return v.length>1 ? decodeURIComponent(v.pop().split(';').shift()||'') : '';
}

/** ====== Rescate desde CacheStorage (iOS) ====== **/
async function restoreFromCache(){
  try{
    if(!('caches' in self)) return false;
    const cache = await caches.open('tp-session');
    const res = await cache.match('/session');
    if(!res) return false;
    const { token, redirect, email } = await res.json();
    if(!(token && redirect)) return false;

    // Repoblar localStorage
    localStorage.setItem('tp_token_v1', token);
    localStorage.setItem('tp_redirect', redirect);
    if (email) localStorage.setItem('tp_email', email);

    // Repoblar cookies (1 año)
    const ONE_YEAR = 60*60*24*365;
    setCookie('tp_token_v1', token, ONE_YEAR);
    setCookie('tp_redirect', redirect, ONE_YEAR);
    if (email) setCookie('tp_email', email, ONE_YEAR);
    return true;
  }catch(e){ return false; }
}

(async function boot(){
  // Intento de rescate ANTES de leer localStorage/cookies
  await restoreFromCache();

  const tk   = localStorage.getItem('tp_token_v1') || getCookie('tp_token_v1') || '';
  const red  = localStorage.getItem('tp_redirect') || getCookie('tp_redirect') || '';
  const mail = localStorage.getItem('tp_email')    || getCookie('tp_email')    || '';

  if (tk && red && red !== '/') {
    location.replace(red);  // Ir directo a la interfaz autorizada
    return;
  }
  // Si no hay token o redirect válido, ir a la puerta
  location.replace(DOOR);
})();
</script>
</body>
</html>

