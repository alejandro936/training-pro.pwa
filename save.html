<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Guardando sesi√≥n‚Ä¶</title>
  <style>
    body {
      font-family: sans-serif;
      background: #000;
      color: #fff;
      padding: 20px;
    }
    h1 { font-size: 1.5em; margin-bottom: 10px; }
    pre { background: #111; padding: 10px; border-radius: 6px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>üíæ Guardando sesi√≥n</h1>
  <div id="output"><pre>Cargando‚Ä¶</pre></div>

  <script>
    function extractParams() {
      const fromSearch = new URLSearchParams(location.search);
      const fromReferrer = new URLSearchParams(document.referrer.split('?')[1] || '');

      const tk    = fromSearch.get('tk')    || fromReferrer.get('tk')    || '';
      const redir = fromSearch.get('redir') || fromReferrer.get('redir') || '/';
      const email = fromSearch.get('email') || fromReferrer.get('email') || '';

      return { tk, redir, email };
    }

    (async function () {
      const { tk, redir, email } = extractParams();
      const out = [];

      out.push(`üìß Email recibido: ${email || '[NO ENVIADO]'}`);
      out.push(`üîë Token recibido: ${tk || '[NO ENVIADO]'}`);
      out.push(`‚û°Ô∏è Redirecci√≥n recibida: ${redir || '[NO ENVIADO]'}`);

      // Guardar en localStorage y cookies
      try {
        localStorage.setItem('tp_token_v1', tk);
        localStorage.setItem('tp_redirect', redir);
        localStorage.setItem('tp_email', email);
        document.cookie = 'tp_token_v1=' + encodeURIComponent(tk) + '; path=/; max-age=31536000; SameSite=None; Secure';
        document.cookie = 'tp_redirect=' + encodeURIComponent(redir) + '; path=/; max-age=31536000; SameSite=None; Secure';
        document.cookie = 'tp_email=' + encodeURIComponent(email) + '; path=/; max-age=31536000; SameSite=None; Secure';
        out.push('‚úÖ Guardado en localStorage y cookies');
      } catch (e) {
        out.push('‚ùå Error guardando en localStorage/cookies');
      }

      // Guardar en CacheStorage
      try {
        const cache = await caches.open('tp-session');
        const response = new Response(JSON.stringify({ token: tk, redirect: redir }), {
          headers: { 'Content-Type': 'application/json' }
        });
        await cache.put('/session', response);
        out.push('‚úÖ Guardado en CacheStorage');
      } catch (e) {
        out.push('‚ùå Error guardando en CacheStorage');
      }

      // Guardar en servidor
      try {
        await fetch('https://script.google.com/macros/s/AKfycbz8d_Zx_iK2Yn8ojMQGjrTigZIKlGpKyM_ln4-zFAeG7vL62550SdHa-szs3ZEAui8E/exec?email='
          + encodeURIComponent(email)
          + '&token=' + encodeURIComponent(tk)
          + '&redirect=' + encodeURIComponent(redir));
        out.push('‚úÖ Enviado al servidor');
      } catch (e) {
        out.push('‚ùå Error enviando al servidor');
      }

      document.getElementById('output').innerHTML = `<pre>${out.join('\n')}</pre>`;
      setTimeout(() => location.replace(redir), 3000);
    })();
  </script>
</body>
</html>
