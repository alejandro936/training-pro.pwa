<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Guardando sesión…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
  <style>
    :root { color-scheme: dark; }
    html,body{height:100%}
    body{
      margin:0; background:#000; color:#fff; font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial;
      display:grid; place-items:center; padding:24px;
    }
    .card{
      width:min(640px,92vw);
      background:#0c0c0c; border:1px solid #1d1d1d; border-radius:14px; padding:22px;
      text-align:center; box-shadow:0 10px 24px rgba(0,0,0,.35);
    }
    h1{margin:0 0 10px; font-size:18px}
    .muted{opacity:.8; font-size:14px}
    .spinner{
      margin:16px auto 6px; width:28px; height:28px; border-radius:50%;
      border:3px solid rgba(255,255,255,.18); border-top-color:#E6C06E;
      animation:spin 0.8s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="card" role="status" aria-live="polite" aria-busy="true">
    <div class="spinner" aria-hidden="true"></div>
    <h1>Guardando sesión…</h1>
    <p class="muted">Un momento, por favor.</p>
  </div>

<script>
/* ========= util ========= */
function getParams(){
  const qs1 = new URLSearchParams(location.search);
  const qs2 = new URLSearchParams((document.referrer.split('?')[1]||''));
  const tk    = qs1.get('tk')    || qs2.get('tk')    || '';
  const redir = qs1.get('redir') || qs2.get('redir') || '/';
  const email = qs1.get('email') || qs2.get('email') || '';
  return { tk, redir, email };
}
function setCookie(name, value, maxAgeSec){
  document.cookie = name + '=' + encodeURIComponent(value)
    + '; path=/; max-age=' + (maxAgeSec||31536000)
    + '; SameSite=None; Secure';
}

/* ========= main ========= */
(async function(){
  const { tk, redir, email } = getParams();
  const target = redir && redir !== '/' ? redir : '/interfaz/';

  // 1) localStorage + cookies
  try{
    if (tk) localStorage.setItem('tp_token_v1', tk);
    if (email) localStorage.setItem('tp_email', email);
    if (target) localStorage.setItem('tp_redirect', target);

    if (tk) setCookie('tp_token_v1', tk);
    if (email) setCookie('tp_email', email);
    if (target) setCookie('tp_redirect', target);
  }catch(_){}

  // 2) CacheStorage (para rescate offline)
  try{
    if ('caches' in self){
      const cache = await caches.open('tp-session');
      await cache.put('/session', new Response(
        JSON.stringify({ token: tk || null, redirect: target, email: email || null }),
        { headers: { 'Content-Type': 'application/json' } }
      ));
    }
  }catch(_){}

  // 3) (Opcional) Avisar a tu GAS para guardado servidor
  //    Cambia la URL si usas este endpoint; o comenta este bloque si no lo necesitas.
  try{
    const GAS_SAVE_URL = 'https://script.google.com/macros/s/AKfycbz8d_Zx_iK2Yn8ojMQGjrTigZIKlGpKyM_ln4-zFAeG7vL62550SdHa-szs3ZEAui8E/exec';
    if (email && target) {
      const u = new URL(GAS_SAVE_URL);
      if (tk) u.searchParams.set('token', tk);
      u.searchParams.set('email', email);
      u.searchParams.set('redirect', target);
      // No esperamos la respuesta para no bloquear la UX
      fetch(u.toString()).catch(()=>{});
    }
  }catch(_){}

  // 4) Redirigir (garantizamos al menos ~600ms para que dé tiempo a guardar)
  const MIN_WAIT = 600;
  const start = performance.now();
  const waitLeft = Math.max(0, MIN_WAIT - (performance.now() - start));
  setTimeout(() => location.replace(target), waitLeft);
})();
</script>
</body>
</html>
