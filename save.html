<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Training Pro — Guardando…</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<style>
  body{margin:0;background:#0b0d12;color:#fff;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{min-height:100dvh;display:grid;place-items:center;padding:32px}
  .card{max-width:640px;width:100%;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:24px}
  h1{font-weight:800;font-size:24px;margin:0 0 10px}
  p{opacity:.8;line-height:1.6;margin:0}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Guardando acceso…</h1>
      <p>Configurando tu sesión segura.</p>
    </div>
  </div>

<script>
/* ================== BASE & URL HELPERS ================== */
const BASE = new URL('.', location.href);
const url  = (rel) => new URL(rel, BASE).toString();
const SESSION_URL = url('session');
const HOME_URL    = url('index.html');

/* ====== Parámetros recibidos ====== */
// Espera ?email=...&token=...&redirect=...
const params   = new URLSearchParams(location.search);
const email    = params.get('email')    || '';
const tk       = params.get('token')    || '';
const redirect = params.get('redirect') || '';

function toAbsMaybe(p){
  try{ return p && !/^https?:\/\//i.test(p) ? url(p) : p; }catch{ return p; }
}

/* ====== Cookies ====== */
function setCookie(name, value, maxAgeSec){
  const exp = new Date(Date.now() + maxAgeSec*1000).toUTCString();
  document.cookie = name + '=' + encodeURIComponent(value)
    + '; path=' + BASE.pathname
    + '; max-age=' + maxAgeSec
    + '; expires=' + exp
    + '; SameSite=Lax; Secure';
}

(async function saveAndGo(){
  try{
    if (email)    localStorage.setItem('tp_email', email);
    if (tk)       localStorage.setItem('tp_token_v1', tk);
    if (redirect) localStorage.setItem('tp_redirect', redirect);

    const ONE_YEAR = 60*60*24*365;
    if (email)    setCookie('tp_email', email, ONE_YEAR);
    if (tk)       setCookie('tp_token_v1', tk, ONE_YEAR);
    if (redirect) setCookie('tp_redirect', redirect, ONE_YEAR);

    if ('caches' in self) {
      const cache = await caches.open('tp-session');
      const payload = { token: tk || null, redirect: redirect || '', email: email || null };
      await cache.put(SESSION_URL, new Response(JSON.stringify(payload), {
        headers:{'Content-Type':'application/json'}
      }));
    }

    const target = redirect ? toAbsMaybe(redirect) : HOME_URL;
    location.replace(target);
  }catch(e){
    console.warn('saveAndGo error', e);
    location.replace(HOME_URL);
  }
})();
</script>
</body>
</html>
